<style>
    body {
        background: #d2d2d2;
    }
    /* Pour que les liens ne soient pas soulignés */
    a {
        text-decoration: none;
    }
    img {
        vertical-align: middle;
    }
    /* Conteneur principal des blocs de la page */
    #container {
        width: 80%;
        margin: 50px auto;
        padding: 2px 20px 20px 20px;
        background: #fff;
    }

    /* Bloc contenant la zone de texte et bouton */
    .post_message  {
        width: 95%;
        margin: auto;
        border: 1px solid #d2d2d2;
        background: #f8fafd;
        padding: 3px;
    }
    /* Zone de texte */
    .post_message #message {
        width: 80%;
    }
    /* Bouton d'envoi */
    .post_message #post {
        width: 18%;
    }

    /* La zone où sont affichés les messages
    et utilisateurs connectés */
    .chat {
        width: 95%;
        margin: 10px auto;
        border: 1px solid #d2d2d2;
        padding: 0px;
    }
    /* Bloc de chargement */
    .chat #loading {
        margin-top: 50px;
    }
    /* Annonce */
    .chat #annonce {
        background: #f8fafd;
        margin: -6px -7px 5px -7px;
        padding: 5px;
        height:20px;
        box-shadow: 8px 8px 12px #aaa;
        -webkit-box-shadow: 0px 8px 15px #aaa;
    }
    /* Zone des messages */
    .chat #text-td {
        margin: 0px; 
        padding: 5px; 
        width: 80%; 
        background: #fff; 
    }
    /* Zone des utilisateurs connectés */
    .chat #users-td, .chat #users-chat-td {
        margin: 0px; 
        padding: 5px; 
        width: 20%; 
        background: #ddd;
    }
    .chat #text, .chat #users, .chat #users-chat {
        height:500px; 
        overflow-y: auto;
    }

    /* Modification du statut */
    .status {
        width: 95%;
        border: none;
        background: #fff;
        margin: auto;
        text-align: right;
    }

    .info {
        color: green;
    }
    ul.contact{
        list-style: none;
    }

    ul.contact li {
        padding:10px;

    }

    ul.contact li a{

        padding:10px;
    }

    ul.contact li a.selected{
        background-color: green;
        color:white;
    }

    ul.contact li a:hover{
        background-color: blue;
        color:white;
    }

</style>

<script type="text/javascript" src="{{asset('js/jquery.js')}}"></script> 
<div id="container">

    <h1>Mon super chat</h1>


    <!-- Statut //////////////////////////////////////////////////////// -->                

    <table class="chat"><tr>        

            <!-- zone des messages -->

            <td valign="top" id="text-td">

                <div id="annonce"></div>

                <div id="text">

                    <div id="loading">

                        <ul id="listMessage">
                            
                        </ul>

                    </div>

                </div>

            </td>



            <!-- colonne avec les membres connectés au chat -->

            <td valign="top" id="users-td"><div id="users">Chargement</div></td>

        </tr></table>
    <!-- Zone de texte //////////////////////////////////////////////////////// -->

    <a name="post"></a>

    <table class="post_message"><tr>

            <td>

                <form action="" method="POST" id="formAddMessage" onsubmit="sendMessage();
                        return false;">
                    <input name="conversation_id" type="integer" id="conversation_id" style="display:none" />
                    <input name="content" type="text" id="message" maxlength="255" />

                    <input type="button" onclick="sendMessage()" value="Envoyer" id="post" />

                </form>

                <div id="responsePost" style="display:none"></div>

            </td>

        </tr></table>

</div>
<script>
    reloadTime = 5000;
    current_user_id = {{app.user.id}};
            current_conversation = null;
    function getUsers() {
        $.ajax({
            type: "POST",
            url: "{{path('wizardalley_chat_user_list')}}",
            success: function(msg) {
                $users = eval(msg);
                $ul = $('<ul class="contact">');
                console.log($users);
                $.each($users, function($index, $value) {
                    $li = $('<li>');
                    $a = $('<a onClick="javascript:selectChat(' + $value['id_id'] + ',this,'+$value['chat_conversation_id']+')" userId="' + $value['id'] + '">' + $value['username'] + '</a>');

                    $li.append($a);
                    $ul.append($li);
                });
                $('#users').html($ul);
                console.log($ul);

            },
            error: function(msg) {

                // On alerte d'une erreur
                alert('Erreur');

            }

        });
    }

    function selectChat(id, object,conversation_id) {
        $('.contact li a').removeClass('selected');
        $(object).addClass('selected');
        console.log(conversation_id);
        $('#conversation_id').val(conversation_id);
        $.ajax({
            type: "POST",
            url: "{{path('wizardalley_chat_conversation_2_user')}}",
            data: 'user_id=' + id,
            success: function(msg) {
                $message = eval(msg);
                fillChat($message);
            },
            error: function(msg) {

                // On alerte d'une erreur
                alert('Erreur');

            }

        });
    }


    function fillChat(messages) {
        ul = $('#listMessage');
        ul.empty();
        $.each(messages, function(index, item) {
            ul.append(addMessage(item));
        });
    }

    function addMessage(item){
        if (item.user_id == current_user_id) {
            li = $('<li class="self">' + item.username + ': ' + item.content + '</li>');
        } else {
            li = $('<li class="other">' + item.username + ': ' + item.content + '</li>');
        }
        return li;
        
    }

    function sendMessage() {
        data = $("form").serialize();
        $.ajax({
            type: "POST",
            url: "{{path('wizardalley_chat_conversation_add_message')}}",
            data: $("#formAddMessage").serialize(),
            success: function(msg) {
                ul = $('#listMessage');
                ul.append(addMessage(msg));
            }

        });
    }
    getUsers();
//window.setInterval(getUsers, reloadTime);
</script>
